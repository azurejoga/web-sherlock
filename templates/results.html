{% extends "base.html" %}

{% block title %}{{ translations.search_results }} - {{ translations.app_title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Page header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-chart-bar text-success me-2"></i>
                {{ translations.search_results }}
            </h1>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                <i class="fas fa-plus me-1"></i>{{ translations.new_search }}
            </a>
        </div>

        <!-- Progress card -->
        <div class="card mb-4" id="progressCard">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0" id="progressStatus">{{ translations.search_starting }}</h6>
                    <div class="spinner-border spinner-border-sm text-primary" role="status" id="loadingSpinner">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                         role="progressbar" style="width: 100%" id="progressBar"></div>
                </div>
                <small class="text-muted mt-2 d-block" id="progressMessage">{{ translations.search_starting }}</small>
                <div class="mt-2" id="progressDetails">
                    <small class="text-info">
                        <span id="currentSite"></span>
                        <span id="sitesProgress"></span>
                    </small>
                </div>
            </div>
        </div>

        <!-- Results summary card -->
        <div class="card mb-4" id="summaryCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    {% if language == 'pt' %}
                        Resumo da Busca
                    {% else %}
                        Search Summary
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border-end">
                            <h4 class="text-primary mb-1" id="totalUsers">-</h4>
                            <small class="text-muted">{{ translations.usernames_searched }}</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border-end">
                            <h4 class="text-success mb-1" id="totalFound">-</h4>
                            <small class="text-muted">{{ translations.profiles_found }}</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border-end">
                            <h4 class="text-warning mb-1" id="totalNotFound">-</h4>
                            <small class="text-muted">{{ translations.profiles_not_found }}</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-info mb-1" id="totalSites">-</h4>
                        <small class="text-muted">{{ translations.total_sites_checked }}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export buttons -->
        <div class="card mb-4" id="exportCard" style="display: none;">
            <div class="card-body">
                <h6>
                    <i class="fas fa-download me-2"></i>
                    {% if language == 'pt' %}
                        Exportar Resultados
                    {% else %}
                        Export Results
                    {% endif %}
                </h6>
                <div class="btn-group flex-wrap" role="group">
                    <a href="#" id="exportJsonBtn" class="btn btn-primary" style="display: none;">
                        <i class="fas fa-file-code me-1"></i>{{ translations.export_json }}
                    </a>
                    <a href="#" id="exportCsvBtn" class="btn btn-success" style="display: none;">
                        <i class="fas fa-file-csv me-1"></i>{{ translations.export_csv }}
                    </a>
                    <a href="#" id="exportPdfBtn" class="btn btn-danger" style="display: none;">
                        <i class="fas fa-file-pdf me-1"></i>{{ translations.export_pdf }}
                    </a>
                    <a href="#" id="exportTxtBtn" class="btn btn-info" style="display: none;">
                        <i class="fas fa-file-alt me-1"></i>{{ translations.export_txt }}
                    </a>
                    <a href="#" id="exportZipBtn" class="btn btn-warning" style="display: none;">
                        <i class="fas fa-file-archive me-1"></i>{{ translations.download_all }}
                    </a>
                </div>
            </div>
        </div>

        <!-- Results table -->
        <div class="card" id="resultsCard" style="display: none;">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        {% if language == 'pt' %}
                            Resultados Detalhados
                        {% else %}
                            Detailed Results
                        {% endif %}
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleFound()">
                            <i class="fas fa-filter me-1"></i>
                            <span id="filterText">
                                {% if language == 'pt' %}
                                    Mostrar apenas encontrados
                                {% else %}
                                    Show only found
                                {% endif %}
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="resultsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>{{ translations.username }}</th>
                                <th>{{ translations.social_network }}</th>
                                <th>{{ translations.profile_url }}</th>
                                <th>{{ translations.status }}</th>
                                <th>{{ translations.response_time }}</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const searchId = '{{ search_id }}';
const translations = {
    found: '{{ translations.found }}',
    not_found: '{{ translations.not_found }}',
    search_completed: '{{ translations.search_completed }}',
    show_only_found: '{% if language == "pt" %}Mostrar apenas encontrados{% else %}Show only found{% endif %}',
    show_all: '{% if language == "pt" %}Mostrar todos{% else %}Show all{% endif %}'
};

let allResults = [];
let showOnlyFound = false;

// Poll for progress updates
function updateProgress() {
    fetch(`/progress/${searchId}`)
        .then(response => response.json())
        .then(data => {
            console.log('Progress data:', data); // Debug log
            
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            const progressMessage = document.getElementById('progressMessage');
            const progressDetails = document.getElementById('progressDetails');
            const currentSite = document.getElementById('currentSite');
            const sitesProgress = document.getElementById('sitesProgress');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // Update status and message
            progressStatus.textContent = data.status || '{{ translations.searching }}';
            progressMessage.textContent = data.message || '{{ translations.loading }}';
            
            // Update progress bar animation - always keep it animated during search
            if (data.completed) {
                progressBar.className = 'progress-bar bg-success';
                progressBar.style.width = '100%';
                loadingSpinner.style.display = 'none';
            } else {
                progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
                progressBar.style.width = '100%';
                loadingSpinner.style.display = 'block';
            }
            
            // Show detailed progress if available
            if (data.current_site) {
                currentSite.textContent = `{{ translations.checking }} ${data.current_site}`;
                progressDetails.style.display = 'block';
            }
            if (data.sites_checked) {
                sitesProgress.textContent = ` | ${data.sites_checked} {{ translations.sites_checked }}`;
            }
            
            if (data.completed) {
                if (data.status === 'completed') {
                    progressStatus.textContent = '{{ translations.completed }}!';
                    progressMessage.textContent = '{{ translations.loading }}';
                    setTimeout(() => loadResults(), 500);
                } else {
                    // Error occurred
                    document.getElementById('progressCard').innerHTML = `
                        <div class="card-body">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ${data.message || '{{ translations.error }}'}
                            </div>
                        </div>
                    `;
                }
            } else {
                setTimeout(updateProgress, 1000);
            }
        })
        .catch(error => {
            console.error('Error fetching progress:', error);
            setTimeout(updateProgress, 2000);
        });
}

// Load and display results
function loadResults() {
    fetch(`/results/${searchId}`)
        .then(response => response.json())
        .then(data => {
            allResults = data;
            displayResults(data);
            
            // Setup export buttons
            const exportButtons = [
                { id: 'exportJsonBtn', format: 'json', filename: `sherlock_results_${searchId}.json` },
                { id: 'exportCsvBtn', format: 'csv', filename: `sherlock_results_${searchId}.csv` },
                { id: 'exportPdfBtn', format: 'pdf', filename: `sherlock_results_${searchId}.pdf` },
                { id: 'exportTxtBtn', format: 'txt', filename: `sherlock_results_${searchId}.txt` },
                { id: 'exportZipBtn', format: 'zip', filename: `sherlock_results_${searchId}.zip` }
            ];
            
            exportButtons.forEach(button => {
                const btn = document.getElementById(button.id);
                btn.href = `/download/${searchId}/${button.format}`;
                btn.download = button.filename;
                btn.style.display = 'inline-block';
            });
            
            // Hide progress card and show results
            document.getElementById('progressCard').style.display = 'none';
            document.getElementById('summaryCard').style.display = 'block';
            document.getElementById('exportCard').style.display = 'block';
            document.getElementById('resultsCard').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading results:', error);
            document.getElementById('progressCard').innerHTML = `
                <div class="card-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading results: ${error.message}
                    </div>
                </div>
            `;
        });
}

// Display results in table
function displayResults(data) {
    // Update summary
    document.getElementById('totalUsers').textContent = data.usernames.length;
    document.getElementById('totalFound').textContent = data.found_profiles.length;
    document.getElementById('totalNotFound').textContent = data.not_found_profiles.length;
    document.getElementById('totalSites').textContent = data.total_sites_checked;
    
    // Prepare table data
    const tableBody = document.getElementById('resultsTableBody');
    tableBody.innerHTML = '';
    
    // Combine and sort results
    const allProfiles = [
        ...data.found_profiles.map(p => ({...p, found: true})),
        ...data.not_found_profiles.map(p => ({...p, found: false}))
    ].sort((a, b) => {
        if (a.username !== b.username) return a.username.localeCompare(b.username);
        return a.site.localeCompare(b.site);
    });
    
    // Filter results if needed
    const filteredProfiles = showOnlyFound ? 
        allProfiles.filter(p => p.found) : allProfiles;
    
    // Populate table
    filteredProfiles.forEach(profile => {
        const row = document.createElement('tr');
        const statusClass = profile.found ? 'success' : 'secondary';
        const statusText = profile.found ? translations.found : translations.not_found;
        const urlContent = profile.url ? 
            `<a href="${profile.url}" target="_blank" class="text-decoration-none">
                <i class="fas fa-external-link-alt me-1"></i>
                ${profile.url.length > 50 ? profile.url.substring(0, 50) + '...' : profile.url}
            </a>` : '-';
        
        row.innerHTML = `
            <td><strong>${profile.username}</strong></td>
            <td>${profile.site}</td>
            <td>${urlContent}</td>
            <td><span class="badge bg-${statusClass}">${statusText}</span></td>
            <td>${profile.response_time || 0}ms</td>
        `;
        tableBody.appendChild(row);
    });
}



// Toggle found filter
function toggleFound() {
    showOnlyFound = !showOnlyFound;
    displayResults(allResults);
    
    const filterText = document.getElementById('filterText');
    filterText.textContent = showOnlyFound ? translations.show_all : translations.show_only_found;
}

// Start progress monitoring
updateProgress();
</script>
{% endblock %}
